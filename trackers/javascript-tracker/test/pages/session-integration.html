<!DOCTYPE html>
<html>
  <head>
    <title>Session integration test page</title>
  </head>
  <body>
    <p id="title">Page for testing client side sessions with Snowplow Micro</p>

    <script>
      var collector_endpoint = document.cookie.split('container=')[1].split(';')[0];
      var testIdentifier = document.cookie.split('testIdentifier=')[1].split(';')[0].trim();
      document.body.className += ' loaded';
    </script>

    <script>
      (function (p, l, o, w, i, n, g) {
        if (!p[i]) {
          p.GlobalSnowplowNamespace = p.GlobalSnowplowNamespace || [];
          p.GlobalSnowplowNamespace.push(i);
          p[i] = function () {
            (p[i].q = p[i].q || []).push(arguments);
          };
          p[i].q = p[i].q || [];
          n = l.createElement(o);
          g = l.getElementsByTagName(o)[0];
          n.async = 1;
          n.src = w;
          g.parentNode.insertBefore(n, g);
        }
      })(window, document, 'script', './snowplow.js', 'snowplow');

      document.write(collector_endpoint);

      window.snowplow('newTracker', 'cookieSessionTracker', collector_endpoint, {
        appId: 'session-integration-' + testIdentifier,
        sessionCookieTimeout: 1,
        cookieSameSite: 'Lax',
        cookieSecure: false,
        cookieName: testIdentifier,
        contexts: {
          session: true,
          webPage: false,
        },
      });

      setTimeout(function () {
        window.snowplow('trackPageView:cookieSessionTracker');
        window.snowplow('trackPageView:cookieSessionTracker');
      }, 0);

      setTimeout(function () {
        window.snowplow('trackPageView:cookieSessionTracker');
      }, 3000);

      window.snowplow('newTracker', 'localStorageSessionTracker', collector_endpoint, {
        appId: 'session-integration-' + testIdentifier,
        cookieName: testIdentifier,
        sessionCookieTimeout: 1,
        stateStorageStrategy: 'localStorage',
      });

      setTimeout(function () {
        window.snowplow('trackPageView:localStorageSessionTracker');
        window.snowplow('trackPageView:localStorageSessionTracker');
      }, 0);

      setTimeout(function () {
        window.snowplow('trackPageView:localStorageSessionTracker');
      }, 3000);

      window.snowplow('newTracker', 'anonymousSessionTracker', collector_endpoint, {
        appId: 'session-integration-' + testIdentifier,
        cookieName: testIdentifier,
        sessionCookieTimeout: 1,
        stateStorageStrategy: 'localStorage',
        anonymousTracking: { withSessionTracking: true },
      });

      setTimeout(function () {
        window.snowplow('trackPageView:anonymousSessionTracker');
        window.snowplow('trackPageView:anonymousSessionTracker');
      }, 0);

      setTimeout(function () {
        window.snowplow('trackPageView:anonymousSessionTracker');
      }, 3000);
    </script>
  </body>
</html>
